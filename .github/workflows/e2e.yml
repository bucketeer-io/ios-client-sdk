name: E2E tests

on:
  workflow_dispatch:
  workflow_call:

jobs:
  generate-xcode-project:
    if: ${{ github.event.workflow == '.github/workflows/e2e.yml'}}
    uses: ./.github/workflows/generate-xcode-project.yml

  e2e:
    needs: generate-xcode-project
    if: always()
    name: E2E tests
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
        with:
          xcode-version: '15.4'

      # Cache for Homebrew packages (xcbeautify, xcparse)
      - name: Cache Homebrew packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            ~/Library/Caches/Homebrew
            /usr/local/Cellar/xcbeautify
            /usr/local/Cellar/xcparse
            /opt/homebrew/Cellar/xcbeautify
            /opt/homebrew/Cellar/xcparse
          key: ${{ runner.os }}-homebrew-${{ hashFiles('.github/workflows/e2e.yml') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      - name: Download xcode project file
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: output-xcodeproj-file
          path: ./Bucketeer.xcodeproj

      - name: Download environment file
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: output-environment-file
          path: ./

      # Using a third-party action for simulator management
      # Note: Most simulator actions are outdated, so we'll use a simple approach
      - name: Boot Simulator
        uses: futureware-tech/simulator-action@dab10d813144ef59b48d401cd95da151222ef8cd # v4
        with:
          model: 'iPhone 15'
          os_version: '17.5'

      # Build using a more structured approach with actions
      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -scheme Bucketeer \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO

      # Run tests with a cleaner output using xcbeautify
      - name: Install xcbeautify
        run: |
          if ! command -v xcbeautify &> /dev/null; then
            echo "Installing xcbeautify..."
            brew install xcbeautify
          else
            echo "xcbeautify already installed"
          fi

      - name: Run E2E tests
        env:
          E2E_API_ENDPOINT: ${{ secrets.E2E_API_ENDPOINT }}
          E2E_API_KEY: ${{ secrets.E2E_API_KEY }}
        run: |
          set -o pipefail

          xcodebuild test-without-building \
            -scheme Bucketeer \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -derivedDataPath build/DerivedData \
            -resultBundlePath TestResults.xcresult \
            E2E_API_ENDPOINT="$E2E_API_ENDPOINT" \
            E2E_API_KEY="$E2E_API_KEY" | \
          xcbeautify --renderer github-actions

      # Use xcparse for better test result parsing
      - name: Install xcparse
        if: failure()
        run: |
          if ! command -v xcparse &> /dev/null; then
            echo "Installing xcparse..."
            brew install xcparse
          else
            echo "xcparse already installed"
          fi

      - name: Parse test results on failure
        if: failure()
        run: |
          echo "=== Test Results Summary ==="
          xcparse screenshots TestResults.xcresult ./screenshots || true
          xcparse logs TestResults.xcresult ./logs || true

          # Show failed tests
          xcparse tests TestResults.xcresult --failed || echo "No test result details available"

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results-actions
          path: |
            TestResults.xcresult
            screenshots/
            logs/
